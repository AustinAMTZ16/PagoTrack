<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear Tramite</title>
  <link rel="shortcut icon" href="./assets/images/lg_seccion.jpg" type="image/x-icon">

  <script src="./assets/js/SesionUser.js"></script>
  <script src="./assets/js/MenuContenido.js"></script>
  <script src="./assets/js/MenuSistema.js"></script>

  <script type="module" src="./assets/js/TramitesController.js"></script>

  <!-- Bootstrap 5 (CSS + Bundle con Popper) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery (necesario para DataTables) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- QRCode Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Estilos Personalizados  lugar si importa-->
  <link rel="stylesheet" href="./assets/css/TesoreriaStyle.css">
</head>

<body>
  <header>
    <img src="./assets/images/lg_banner.jpg" alt="Logo" class="logo" style="width: 30%; height: 50%;">
    <h1>Sistema Institucional</h1>
  </header>

  <nav class="navbar navbar-expand-lg">
  </nav>

  <main class="container py-4">
    <h2 class="mb-4">Crear Tr√°mite</h2>
    <form id="formcreateTramite" method="post">
      <div class="row g-3">
        <!-- üóÇ DATOS DEL TR√ÅMITE -->
        <h4 class="mt-4 text-primary fw-bold">üóÇ Datos del Tr√°mite</h4>

        <div class="col-md-6">
          <label for="Dependencia" class="form-label">Instituci√≥n</label>
          <select name="Dependencia" id="Dependencia" class="form-select" required>
            <option value="" disabled selected>Instituci√≥n</option>
            <option value="Coordinaci√≥n de las Regidur√≠as">Coordinaci√≥n de las Regidur√≠as</option>
            <option value="Presidencia Municipal">Presidencia Municipal</option>
            <option value="Sindicatura Municipal">Sindicatura Municipal</option>
            <option value="Secretar√≠a del Ayuntamiento">Secretar√≠a del Ayuntamiento</option>
            <option value="Contralor√≠a Municipal">Contralor√≠a Municipal</option>
            <option value="Tesorer√≠a Municipal">Tesorer√≠a Municipal</option>
            <option value="Secretar√≠a General de Gobierno">Secretar√≠a General de Gobierno</option>
            <option value="Secretar√≠a de Bienestar y Participaci√≥n Ciudadana">Secretar√≠a de Bienestar y Participaci√≥n
              Ciudadana</option>
            <option value="Secretar√≠a para la Igualdad Sustantiva de G√©nero">Secretar√≠a para la Igualdad Sustantiva de
              G√©nero</option>
            <option value="Secretar√≠a de Administraci√≥n y Tecnolog√≠as de la Informaci√≥n">Secretar√≠a de Administraci√≥n y
              Tecnolog√≠as de la Informaci√≥n</option>
            <option value="Secretar√≠a de Gesti√≥n y Desarrollo Urbano">Secretar√≠a de Gesti√≥n y Desarrollo Urbano</option>
            <option value="Gerencia del Centro Hist√≥rico y Patrimonio Cultural">Gerencia del Centro Hist√≥rico y
              Patrimonio Cultural</option>
            <option value="Secretar√≠a de Econom√≠a y Turismo">Secretar√≠a de Econom√≠a y Turismo</option>
            <option value="Secretar√≠a de Movilidad e Infraestructura">Secretar√≠a de Movilidad e Infraestructura</option>
            <option value="Secretar√≠a de Seguridad Ciudadana">Secretar√≠a de Seguridad Ciudadana</option>
            <option value="Secretar√≠a de Servicios P√∫blicos">Secretar√≠a de Servicios P√∫blicos</option>
            <option value="Secretar√≠a de Medio Ambiente">Secretar√≠a de Medio Ambiente</option>
            <option value="Coordinaci√≥n General de Transparencia y Municipio Abierto">Coordinaci√≥n General de
              Transparencia y Municipio Abierto</option>
            <option value="Coordinaci√≥n General de Comunicaci√≥n Social">Coordinaci√≥n General de Comunicaci√≥n Social
            </option>
            <option value="Direcci√≥n General de Desarrollo y Formaci√≥n Profesional">Direcci√≥n General de Desarrollo y
              Formaci√≥n Profesional</option>
            <option value="Sistema Municipal DIF">Sistema Municipal DIF</option>
            <option value="Instituto Municipal del Deporte de Puebla">Instituto Municipal del Deporte de Puebla</option>
            <option value="Instituto de la Juventud del Municipio de Puebla">Instituto de la Juventud del Municipio de
              Puebla</option>
            <option value="Instituto Municipal de Arte y Cultura de Puebla">Instituto Municipal de Arte y Cultura de
              Puebla</option>
            <option value="Organismo Operador del Servicio de Limpia del Municipio de Puebla">Organismo Operador del
              Servicio de Limpia del Municipio de Puebla</option>
            <option value="Industrial de Abastos de Puebla">Industrial de Abastos de Puebla</option>
            <option value="Instituto Municipal de Planeaci√≥n">Instituto Municipal de Planeaci√≥n</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="Proveedor" class="form-label">Proveedor</label>
          <input type="text" name="Proveedor" id="Proveedor" class="form-control" placeholder="Proveedor" required>
        </div>

        <div class="col-12">
          <label for="Concepto" class="form-label">Concepto</label>
          <textarea name="Concepto" id="Concepto" class="form-control" rows="3" required
            placeholder="Ejemplo: describe el tipo de pago (servicio, producto o egreso)."></textarea>
        </div>

        <div class="col-md-6">
          <label for="TipoTramite" class="form-label">Tipo de Tr√°mite</label>
          <select name="TipoTramite" id="TipoTramite" class="form-select" required>
            <option value="" disabled selected>Tipo de Tr√°mite</option>
            <option value="OC">OC Ordenes Compromiso</option>
            <option value="OP">OP √ìrdenes de Pago</option>
            <option value="SRF">SRF Solicitud de Recurso Financieros</option>
            <option value="CRF">CRF Comprobaci√≥n de Recurso Financieros</option>
            <option value="JA">Juntas Auxiliares</option>
            <option value="IPS">Inspector√≠as</option>
            <option value="OCO">Ordenes Compromiso Obras</option>
            <option value="OPO">Ordenes Pago Obras</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="Mes" class="form-label">Mes</label>
          <select name="Mes" id="Mes" class="form-select" required>
            <option value="" disabled selected>Mes</option>
            <option value="Enero">Enero</option>
            <option value="Febrero">Febrero</option>
            <option value="Marzo">Marzo</option>
            <option value="Abril">Abril</option>
            <option value="Mayo">Mayo</option>
            <option value="Junio">Junio</option>
            <option value="Julio">Julio</option>
            <option value="Agosto">Agosto</option>
            <option value="Septiembre">Septiembre</option>
            <option value="Octubre">Octubre</option>
            <option value="Noviembre">Noviembre</option>
            <option value="Diciembre">Diciembre</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="Estatus" class="form-label">Estatus</label>
          <select name="Estatus" id="Estatus" class="form-select" required>
            <option value="" disabled selected>Estatus</option>
            <option value="Creado">Creado</option>
            <!-- <option value="Turnado">Turnado</option> -->
          </select>
        </div>

        <div class="col-md-6">
          <label for="AnalistaID" class="form-label">Analista</label>
          <select name="AnalistaID" id="AnalistaID" class="form-select" required>
            <option value="">Seleccionar Analista</option>
            <option value="1">Agust√≠n Arenas Martinez</option>
            <option value="4">Juan Carlos Garc√≠a Tagle</option>
            <option value="22">Gonzalo Ochoa Huerta</option>
            <option value="8">Isabel Cristina Pav√≥n Nava</option>
            <option value="11">Isabel Cortes Varillas</option>
            <option value="20">Maria Isabel Mar√≠n Le√≥n</option>
            <option value="21">Ariosto Emilio Lechuga Aparicio</option>
            <option value="23">Laura Alatriste Torres</option>
            <option value="5">Maria Blanca Soriano Rojas</option>
            <option value="17">Maria Del Carmen Damian Aguilar</option>
            <option value="10">Maria De Lourdes Molina Quiroz</option>
            <option value="7">Maria De Lourdes Gutierrez Casta√±eda</option>
            <option value="16">Maria Valeria Corro Stefanoni</option>
            <option value="12">Ariadna Michel S√°nchez Rodr√≠guez</option>
            <option value="13">Michelle C√≥rdova Torres</option>
            <option value="19">Francisco Javier Rivera Castillo</option>
            <option value="15">Antonio Casta√±on Ruiz</option>
            <option value="18">Ofelia Olguin Aguilar</option>
            <option value="6">Xochil Cuatepitzi Torres</option>
            <option value="14">Daniel Rodr√≠guez Cardenas</option>
            <option value="9">Roberta Marcela Uvera Saucedo</option>
            <option value="48">Erika Lopez Zepeda</option>
            <option value="49">Luis Enrique Silva Santiago</option>
<option value="46">Nahim Nava Ortiz</option>
          </select>
        </div>

        <!-- üí∞ FONDOS ASOCIADOS -->
        <h4 class="mt-4 text-primary fw-bold">üí∞ Fondos Asociados</h4>

        <div class="col-md-6">
          <input type="text" id="FondoInput" placeholder="Ejemplo: 10050" class="form-control">
        </div>
        <div class="col-md-6">
          <input type="text" id="ImporteInput" placeholder="Ejemplo: 200000" class="form-control">
        </div>

        <div class="col-12 mt-2">
          <button type="button" id="addFondoBtn" class="btn btn-success">Agregar Fondo</button>
        </div>

        <div class="col-12">
          <table id="fondosTable" class="table mt-3">
            <thead>
              <tr>
                <th>Fondo</th>
                <th>Importe</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <input type="hidden" name="Fondo" id="Fondo">
        </div>

        <div class="col-md-12">
          <label for="Importe" class="form-label">Importe Total</label>
          <input type="number" name="Importe" id="Importe" class="form-control" placeholder="999999999.99" readonly
            required>
        </div>

        <!-- üóì FECHAS CLAVE -->
        <h4 class="mt-4 text-primary fw-bold">üóì Fechas Clave</h4>

        <div class="col-md-6">
          <label for="FechaRecepcion" class="form-label">Fecha Recepci√≥n <span class="small-text">(sello de la caratula
              del
              oficio)</span></label>
          <input type="date" name="FechaRecepcion" id="FechaRecepcion" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label for="FechaLimite" class="form-label">Fecha L√≠mite</label>
          <input type="date" name="FechaLimite" id="FechaLimite" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label for="FechaLimitePago" class="form-label">Fecha L√≠mite de Pago</label>
          <input type="date" name="FechaLimitePago" id="FechaLimitePago" class="form-control">
        </div>

        <!-- üìÑ REFERENCIA ADMINISTRATIVA -->
        <h4 class="mt-4 text-primary fw-bold">üìÑ Referencia Administrativa</h4>

        <div class="col-md-6">
          <label for="OfPeticion" class="form-label">Oficio de Petici√≥n</label>
          <input type="text" name="OfPeticion" id="OfPeticion" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label for="NoTramite" class="form-label">N√∫mero de Tr√°mite</label>
          <input type="text" name="NoTramite" id="NoTramite" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label for="DoctacionAnexo" class="form-label">Dotaci√≥n Anexa</label>
          <input type="text" name="DoctacionAnexo" id="DoctacionAnexo" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label for="FK_SRF" class="form-label">Relaci√≥n SRF</label>
          <input type="text" name="FK_SRF" id="FK_SRF" class="form-control">
        </div>

        <!-- üí¨ COMENTARIOS -->
        <h4 class="mt-4 text-primary fw-bold">üí¨ Comentarios Finales</h4>

        <div class="col-12">
          <label for="Comentarios" class="form-label">Comentarios</label>
          <textarea name="Comentarios" id="Comentarios" class="form-control" rows="4" required>SE VALIDA CHECK LIST Y REGISTRADO EN PAGOTRACK.</textarea>
        </div>

        <!-- üöÄ BOTONES -->
        <div class="col-12 d-flex justify-content-between mt-4">
          <button type="submit" class="btn btn-primary">Crear Tr√°mite</button>
          <a href="dashboard.html" class="btn btn-secondary">Regresar</a>
        </div>

      </div>
    </form>
  </main>

  <script>
    // LOGICA PARA AGREGAR FONDOS
    let importesFF = {};    
    document.getElementById('addFondoBtn').addEventListener('click', function () {
      let fondo = document.getElementById('FondoInput').value.trim();
      let importe = document.getElementById('ImporteInput').value.trim();

      if (fondo === '' || importe === '') {
        alert("Debes ingresar un fondo y un importe");
        return;
      }

      if (importesFF[fondo]) {
        alert("Este fondo ya ha sido agregado.");
        return;
      }

      importesFF[fondo] = importe;
      actualizarTabla();
      actualizarCampoOculto();
      limpiarInputs();
    });
    // LOGICA PARA AGREGAR FONDOS

    // LOGICA PARA OCULTAR CAMPO SRF
    document.addEventListener('DOMContentLoaded', function () {
      const tipoTramite = document.getElementById('TipoTramite');
      const campoSRF = document.getElementById('FK_SRF');
      const contenedorSRF = campoSRF.closest('.col-md-6'); // oculta tambi√©n la etiqueta y padding
      // Ocultar al cargar
      contenedorSRF.style.display = 'none';
      campoSRF.removeAttribute('required');
      // Escuchar cambios
      tipoTramite.addEventListener('change', function () {
        if (this.value === 'CRF') {
          contenedorSRF.style.display = 'block';
          campoSRF.setAttribute('required', 'required');
        } else {
          contenedorSRF.style.display = 'none';
          campoSRF.removeAttribute('required');
          campoSRF.value = ''; // Limpiar valor por si acaso
        }
      });
      // LOGICA PARA OCULTAR CAMPO SRF

      // LOGICA PARA CALCULAR FECHAS
      const campoFecha = document.getElementById('FechaLimite');
      // const FechaLimitePago = document.getElementById('FechaLimitePago');
      const inputFechaRecepcion = document.getElementById('FechaRecepcion');

      // Escucha cuando el usuario elige una fecha
      inputFechaRecepcion.addEventListener('change', function () {
        const valorFecha = inputFechaRecepcion.value;

        if (valorFecha) {
          const fechaBase = new Date(valorFecha);
          const fechaLimite = sumarDiasHabiles(fechaBase, 5);

          const yyyy = fechaLimite.getFullYear();
          const mm = String(fechaLimite.getMonth() + 1).padStart(2, '0');
          const dd = String(fechaLimite.getDate()).padStart(2, '0');
          const fechaFormateada = `${yyyy}-${mm}-${dd}`;

          campoFecha.value = fechaFormateada;
          // FechaLimitePago.value = fechaFormateada;
        }
      });

      // Si ya quieres calcular al cargar la p√°gina con la fecha actual
      window.addEventListener('load', function () {
        if (!inputFechaRecepcion.value) {
          const hoy = new Date();
          const fechaLimite = sumarDiasHabiles(hoy, 5);
          const yyyy = fechaLimite.getFullYear();
          const mm = String(fechaLimite.getMonth() + 1).padStart(2, '0');
          const dd = String(fechaLimite.getDate()).padStart(2, '0');
          const fechaFormateada = `${yyyy}-${mm}-${dd}`;
          campoFecha.value = fechaFormateada;
          // FechaLimitePago.value = fechaFormateada;
        }
      });
      // LOGICA PARA CALCULAR FECHAS

    });

    function actualizarTabla() {
      let tbody = document.querySelector('#fondosTable tbody');
      tbody.innerHTML = '';

      for (let fondo in importesFF) {
        let row = `<tr>
                            <td>${fondo}</td>
                            <td>${parseFloat(importesFF[fondo]).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}</td>
                            <td><button type="button" class="btn btn-primary toggleButton" onclick="eliminarFondo('${fondo}')">Eliminar</button></td>
                        </tr>`;
        tbody.innerHTML += row;
      }
    }

    function eliminarFondo(fondo) {
      delete importesFF[fondo];
      actualizarTabla();
      actualizarCampoOculto();
    }

    function actualizarCampoOculto() {
      document.getElementById('Fondo').value = JSON.stringify(importesFF);
      //console.log(document.getElementById('Fondo').value);

      // Convertimos los valores del objeto a n√∫meros y sumamos
      let sumaTotal = Object.values(importesFF).reduce((total, valor) => total + parseFloat(valor), 0);

      // Asignamos el resultado al input con formato de 2 decimales
      document.getElementById('Importe').value = sumaTotal.toFixed(2);
    }

    function limpiarInputs() {
      document.getElementById('FondoInput').value = '';
      document.getElementById('ImporteInput').value = '';
    }

    // Funci√≥n para sumar d√≠as h√°biles (excluye s√°bados y domingos)
    function sumarDiasHabiles(fechaInicial, diasHabiles) {
      let fecha = new Date(fechaInicial);
      let diasSumados = 0;

      while (diasSumados < diasHabiles) {
        fecha.setDate(fecha.getDate() + 1);
        const dia = fecha.getDay();
        // 0 = domingo, 6 = s√°bado ‚Üí saltar fines de semana
        if (dia !== 0 && dia !== 6) {
          diasSumados++;
        }
      }

      return fecha;
    }
  </script>

  <footer>
    <p>¬© 2025 Sistema PagoTrack - Gesti√≥n de Pagos</p>
  </footer>
</body>

</html>