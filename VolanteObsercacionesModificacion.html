<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Modificaciòn Volante de Observaciones</title>
    <link rel="shortcut icon" href="./assets/images/lg_seccion.jpg" type="image/x-icon">
    <script src="./assets/js/SesionUser.js"></script>
    <script src="./assets/js/MenuContenido.js"></script>
    <script src="./assets/js/MenuSistema.js"></script>

    <!-- Bootstrap 5 (CSS + Bundle con Popper) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (necesario para DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- QRCode Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Descarga de EXCEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- Estilos Personalizados  lugar si importa-->
    <link rel="stylesheet" href="./assets/css/TesoreriaStyle.css">
    <!-- Estilos de Font Awesome -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>
    <header>
        <img src="./assets/images/lg_banner.jpg" alt="Logo" class="logo" style="width: 30%; height: 50%;">
        <h1>Sistema Institucional</h1>
    </header>

    <nav class="navbar navbar-expand-lg">
    </nav>
    <main>
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <h1 class="mb-4">Modificar Volante de Observaciones</h1>

                    <form id="formModificarVolante">
                        <!-- SECCIÓN DE DATOS NO MODIFICABLES -->
                        <h3 class="mb-3">Información del Volante</h3>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="folioVolante" class="form-label">Folio del Volante</label>
                                <input type="text" class="form-control" id="folioVolante" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="tramiteId" class="form-label">ID del Trámite</label>
                                <input type="text" class="form-control" id="tramiteId" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaEmision" class="form-label">Fecha de Creación</label>
                                <input type="text" class="form-control" id="fechaEmision" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaLimite" class="form-label">Fecha Límite de Solventación</label>
                                <input type="text" class="form-control" id="fechaLimite" readonly>
                            </div>
                        </div>

                        <!-- SECCIÓN DE DATOS MODIFICABLES -->
                        <h3 class="mb-3">Campos Editables</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="estatusVolante" class="form-label">Estatus</label>
                                <select id="estatusVolante" class="form-select" readonly>
                                    <option value="Creado">Creado</option>
                                    <option value="Emitido">Emitido</option>
                                    <option value="Solventado">Solventado</option>
                                    <option value="Vencido">Vencido</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="glosadorNombre" class="form-label">Nombre del Glosador</label>
                                <select name="glosadorNombre" id="glosadorNombre" class="form-select" readonly>
                                    <option value="">Seleccionar Analista</option>
                                    <option value="1">Agustín Arenas Martinez</option>
                                    <option value="4">Juan Carlos García Tagle</option>
                                    <option value="22">Gonzalo Ochoa Huerta</option>
                                    <option value="8">Isabel Cristina Pavón Nava</option>
                                    <option value="11">Isabel Cortes Varillas</option>
                                    <option value="20">Maria Isabel Marín León</option>
                                    <option value="21">Ariosto Emilio Lechuga Aparicio</option>
                                    <option value="23">Laura Alatriste Torres</option>
                                    <option value="5">Maria Blanca Soriano Rojas</option>
                                    <option value="17">Maria Del Carmen Damian Aguilar</option>
                                    <option value="10">Maria De Lourdes Molina Quiroz</option>
                                    <option value="7">Maria De Lourdes Gutierrez Castañeda</option>
                                    <option value="16">Maria Valeria Corro Stefanoni</option>
                                    <option value="12">Ariadna Michel Sánchez Rodríguez</option>
                                    <option value="13">Michelle Córdova Torres</option>
                                    <option value="19">Francisco Javier Rivera Castillo</option>
                                    <option value="15">Antonio Castañon Ruiz</option>
                                    <option value="18">Ofelia Olguin Aguilar</option>
                                    <option value="6">Xochil Cuatepitzi Torres</option>
                                    <option value="14">Daniel Rodríguez Cardenas</option>
                                    <option value="9">Roberta Marcela Uvera Saucedo</option>
                                    <option value="48">Erika Lopez Zepeda</option>
                                    <option value="49">Luis Enrique Silva Santiago</option>
                                    <option value="46">Nahim Nava Ortiz</option>
                                </select>
                            </div>
                            <div class="col-md-4" hidden>
                                <label for="errorId" class="form-label">ID del Error</label>
                                <input type="number" class="form-control" id="errorId" required>
                            </div>
                            <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" rows="4" required></textarea>
                            </div>
                            <div class="col-12">
                                <label for="fundamentoLegal" class="form-label">Fundamento Legal</label>
                                <textarea class="form-control" id="fundamentoLegal" rows="2" required></textarea>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <div class="mt-4 d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="window.history.back();">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>© 2025 Sistema PagoTrack - Gestión de Pagos</p>
    </footer>
    
    

    <script type="module">
        import Global from './assets/js/funcionesGlobales.js';

        // --- ELEMENTOS DEL DOM ---
        const form = document.getElementById('formModificarVolante');

        // --- LÓGICA PRINCIPAL ---
        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const folioDesdeUrl = urlParams.get('FolioVolante');

            if (!folioDesdeUrl) {
                mostrarError("No se proporcionó un FolioVolante en la URL.");
                return;
            }

            await cargarDatosDelVolante(folioDesdeUrl);
        });

        // --- OBTENER Y PINTAR DATOS INICIALES ---
        async function cargarDatosDelVolante(folio) {
            try {
                const url = Global.URL_VolanteObservaciones + 'generarVolanteEspecifico';
                const response = await fetch(url, {
                    method: 'POST', // Tu API espera POST para esta acción
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "FolioVolante": folio })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al obtener los datos del volante.');
                }

                const result = await response.json();
                pintarDatosEnFormulario(result.data);

            } catch (error) {
                mostrarError(error.message);
            }
        }

        function pintarDatosEnFormulario(data) {
            // Campos no modificables
            document.getElementById('folioVolante').value = data.FolioVolante;
            document.getElementById('tramiteId').value = data.ID_CONTRATO;
            document.getElementById('fechaEmision').value = data.FechaEmision;
            document.getElementById('fechaLimite').value = data.FechaLimiteSolventacion;

            // Campos modificables
            document.getElementById('estatusVolante').value = data.EstatusVolante;
            document.getElementById('glosadorNombre').value = data.GlosadorNombre;
            document.getElementById('errorId').value = data.ErrorID;
            document.getElementById('observaciones').value = data.ObservacionEspecifica;
            document.getElementById('fundamentoLegal').value = data.FundamentoLegalVolante;
        }

        // --- ENVIAR ACTUALIZACIÓN ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Evitar el envío tradicional del formulario

            const payload = {
                FolioVolante: document.getElementById('folioVolante').value,
                EstatusVolante: document.getElementById('estatusVolante').value,
                GlosadorNombre: document.getElementById('glosadorNombre').value,
                ErrorID: parseInt(document.getElementById('errorId').value, 10),
                Observaciones: document.getElementById('observaciones').value,
                FundamentoLegal: document.getElementById('fundamentoLegal').value,
            };

            try {
                const url = Global.URL_VolanteObservaciones + 'actualizarVolante';
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Error al actualizar el volante.');
                }
                
                alert(result.message);
                
                // 1. Obtienes el ID del trámite directamente del campo del formulario
                const idDelTramite = document.getElementById('tramiteId').value;
                // 2. Usas ese valor para construir la URL dinámicamente con template literals (``)            
                window.location.href = `VolanteObsercacionesLista.html?tramite_search=${idDelTramite}`; 

            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        function mostrarError(mensaje) {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `<div class="container text-center"><div class="alert alert-danger"><h1>Error</h1><p>${mensaje}</p></div></div>`;
        }
    </script>

</body>

</html>