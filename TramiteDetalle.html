<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Tr√°mite</title>
    <link rel="shortcut icon" href="./assets/images/lg_seccion.jpg" type="image/x-icon">
    <link rel="stylesheet" href="./assets/css/style.css">
    <script src="./assets/js/SesionUser.js"></script>
    <script src="./assets/js/MenuContenido.js"></script>
    <script src="./assets/js/MenuSistema.js"></script>

    <script type="module" src="./assets/js/TramitesController.js"></script>

    <!-- Bootstrap 5 (CSS + Bundle con Popper) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (necesario para DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- QRCode Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Descarga de EXCEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- Estilos Personalizados  lugar si importa-->
    <link rel="stylesheet" href="./assets/css/TesoreriaStyle.css">
</head>

<body>
    <header>
        <img src="./assets/images/lg_banner.jpg" alt="Logo" class="logo" style="width: 30%; height: 50%;">
        <h1>Sistema Institucional</h1>
    </header>

    <nav class="navbar navbar-expand-lg">
    </nav>

    <main class="container py-4">
        <h1 class="mb-4">Detalle de Tr√°mite</h1>
        <form id="formUpdateTramiteCompleto" method="post">
            <div class="row g-3">
                <input type="text" name="ID_CONTRATO" id="ID_CONTRATO" disabled>
                <!-- üóÇ DATOS DEL TR√ÅMITE -->
                <h4 class="mt-4 text-primary fw-bold">üóÇ Datos del Tr√°mite</h4>

                <div class="col-md-6">
                    <label for="Dependencia" class="form-label">Instituci√≥n</label>
                    <select name="Dependencia" id="Dependencia" class="form-control" disabled>
                        <option value="" disabled selected>Instituci√≥n</option>
                        <option value="Coordinaci√≥n de las Regidur√≠as">Coordinaci√≥n de las Regidur√≠as</option>
                        <option value="Presidencia Municipal">Presidencia Municipal</option>
                        <option value="Sindicatura Municipal">Sindicatura Municipal</option>
                        <option value="Secretar√≠a del Ayuntamiento">Secretar√≠a del Ayuntamiento</option>
                        <option value="Contralor√≠a Municipal">Contralor√≠a Municipal</option>
                        <option value="Tesorer√≠a Municipal">Tesorer√≠a Municipal</option>
                        <option value="Secretar√≠a General de Gobierno">Secretar√≠a General de Gobierno</option>
                        <option value="Secretar√≠a de Bienestar y Participaci√≥n Ciudadana">Secretar√≠a de Bienestar y
                            Participaci√≥n
                            Ciudadana</option>
                        <option value="Secretar√≠a para la Igualdad Sustantiva de G√©nero">Secretar√≠a para la Igualdad
                            Sustantiva de
                            G√©nero</option>
                        <option value="Secretar√≠a de Administraci√≥n y Tecnolog√≠as de la Informaci√≥n">Secretar√≠a de
                            Administraci√≥n y
                            Tecnolog√≠as de la Informaci√≥n</option>
                        <option value="Secretar√≠a de Gesti√≥n y Desarrollo Urbano">Secretar√≠a de Gesti√≥n y Desarrollo
                            Urbano
                        </option>
                        <option value="Gerencia del Centro Hist√≥rico y Patrimonio Cultural">Gerencia del Centro
                            Hist√≥rico y
                            Patrimonio Cultural</option>
                        <option value="Secretar√≠a de Econom√≠a y Turismo">Secretar√≠a de Econom√≠a y Turismo</option>
                        <option value="Secretar√≠a de Movilidad e Infraestructura">Secretar√≠a de Movilidad e
                            Infraestructura
                        </option>
                        <option value="Secretar√≠a de Seguridad Ciudadana">Secretar√≠a de Seguridad Ciudadana</option>
                        <option value="Secretar√≠a de Servicios P√∫blicos">Secretar√≠a de Servicios P√∫blicos</option>
                        <option value="Secretar√≠a de Medio Ambiente">Secretar√≠a de Medio Ambiente</option>
                        <option value="Coordinaci√≥n General de Transparencia y Municipio Abierto">Coordinaci√≥n General
                            de
                            Transparencia y Municipio Abierto</option>
                        <option value="Coordinaci√≥n General de Comunicaci√≥n Social">Coordinaci√≥n General de Comunicaci√≥n
                            Social
                        </option>
                        <option value="Direcci√≥n General de Desarrollo y Formaci√≥n Profesional">Direcci√≥n General de
                            Desarrollo y
                            Formaci√≥n Profesional</option>
                        <option value="Sistema Municipal DIF">Sistema Municipal DIF</option>
                        <option value="Instituto Municipal del Deporte de Puebla">Instituto Municipal del Deporte de
                            Puebla
                        </option>
                        <option value="Instituto de la Juventud del Municipio de Puebla">Instituto de la Juventud del
                            Municipio de
                            Puebla</option>
                        <option value="Instituto Municipal de Arte y Cultura de Puebla">Instituto Municipal de Arte y
                            Cultura de
                            Puebla</option>
                        <option value="Organismo Operador del Servicio de Limpia del Municipio de Puebla">Organismo
                            Operador
                            del
                            Servicio de Limpia del Municipio de Puebla</option>
                        <option value="Industrial de Abastos de Puebla">Industrial de Abastos de Puebla</option>
                        <option value="Instituto Municipal de Planeaci√≥n">Instituto Municipal de Planeaci√≥n</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="Proveedor" class="form-label">Proveedor</label>
                    <input type="text" id="Proveedor" class="form-control" disabled>
                </div>

                <div class="col-12">
                    <label for="Concepto" class="form-label">Concepto</label>
                    <textarea id="Concepto" class="form-control" rows="2" disabled></textarea>
                </div>

                <div class="col-md-6">
                    <label for="TipoTramite" class="form-label">Tipo de Tr√°mite</label>
                    <select name="TipoTramite" id="TipoTramite" class="form-control" disabled>
                        <option value="OC">OC Ordenes Compromiso</option>
                        <option value="OP">OP √ìrdenes de Pago</option>
                        <option value="SRF">SRF Solicitud de Recurso Financieros</option>
                        <option value="CRF">CRF Comprobaci√≥n de Recurso Financieros</option>
                        <option value="JA">Juntas Auxiliares</option>
                        <option value="IPS">Inspector√≠as</option>
                        <option value="OCO">Ordenes Compromiso Obras</option>
                        <option value="OPO">Ordenes Pago Obras</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="Mes" class="form-label">Mes</label>
                    <select name="Mes" id="Mes" class="form-control" disabled>
                        <option value="Enero">Enero</option>
                        <option value="Febrero">Febrero</option>
                        <option value="Marzo">Marzo</option>
                        <option value="Abril">Abril</option>
                        <option value="Mayo">Mayo</option>
                        <option value="Junio">Junio</option>
                        <option value="Julio">Julio</option>
                        <option value="Agosto">Agosto</option>
                        <option value="Septiembre">Septiembre</option>
                        <option value="Octubre">Octubre</option>
                        <option value="Noviembre">Noviembre</option>
                        <option value="Diciembre">Diciembre</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="Estatus" class="form-label">Estatus</label>
                    <select name="Estatus" id="Estatus" class="form-control" disabled>
                        <option value="Creado">Creado</option>
                        <option value="Turnado">Turnado</option>
                        <option value="Observaciones">Observaciones</option>
                        <option value="Devuelto">Devuelto</option>
                        <option value="JuntasAuxiliares">Juntas Auxiliares</option>
                        <option value="Inspectoria">Inspector√≠as</option>
                        <option value="RegistradoSAP">Registrado SAP</option>
                        <option value="Remesa">Remesa</option>
                        <option value="RevisionRemesa">Revisi√≥n Remesa</option>
                        <option value="RemesaAprobada">Remesa Aprobada</option>
                        <option value="OrdenesPago">Ordenes de Pago</option>
                        <option value="DevueltoOrdenesPago">Devuelto Ordenes de Pago</option>
                        <option value="Pagado">Pagado Transferencia</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Terminado">Terminado</option>
                        <option value="Rechazado">Rechazado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="Analista" class="form-label">Analista</label>
                    <select name="AnalistaID" id="AnalistaID" class="form-control" disabled>
                            <option value="">Seleccionar Analista</option>
                            <option value="1">Agust√≠n Arenas Martinez</option>
                            <option value="4">Juan Carlos Garc√≠a Tagle</option>
                            <option value="22">Gonzalo Ochoa Huerta</option>
                            <option value="8">Isabel Cristina Pav√≥n Nava</option>
                            <option value="11">Isabel Cortes Varillas</option>
                            <option value="20">Maria Isabel Mar√≠n Le√≥n</option>
                            <option value="21">Ariosto Emilio Lechuga Aparicio</option>
                            <option value="23">Laura Alatriste Torres</option>
                            <option value="5">Maria Blanca Soriano Rojas</option>
                            <option value="17">Maria Del Carmen Damian Aguilar</option>
                            <option value="10">Maria De Lourdes Molina Quiroz</option>
                            <option value="7">Maria De Lourdes Gutierrez Casta√±eda</option>
                            <option value="16">Maria Valeria Corro Stefanoni</option>
                            <option value="12">Ariadna Michel S√°nchez Rodr√≠guez</option>
                            <option value="13">Michelle C√≥rdova Torres</option>
                            <option value="19">Francisco Javier Rivera Castillo</option>
                            <option value="15">Antonio Casta√±on Ruiz</option>
                            <option value="18">Ofelia Olguin Aguilar</option>
                            <option value="6">Xochil Cuatepitzi Torres</option>
                            <option value="14">Daniel Rodr√≠guez Cardenas</option>
                            <option value="9">Roberta Marcela Uvera Saucedo</option>
                            <option value="48">Erika Lopez Zepeda</option>
                            <option value="49">Luis Enrique Silva Santiago</option>
<option value="46">Nahim Nava Ortiz</option>
                    </select>
                </div>


                <!-- üí∞ FONDOS ASOCIADOS -->
                <h4 class="mt-4 text-primary fw-bold">üí∞ Fondos Asociados</h4>

                <div class="col-12">
                    <table id="fondosTable" class="table mt-3">
                        <thead>
                            <tr>
                                <th>Fondo</th>
                                <th>Importe</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <input type="hidden" name="Fondo" id="Fondo">
                </div>

                <div class="col-md-6">
                    <label for="Importe" class="form-label">Importe</label>
                    <input type="text" id="Importe" class="form-control" disabled>
                </div>

                <!-- üóì FECHAS CLAVE -->
                <h4 class="mt-4 text-primary fw-bold">üóì Fechas Clave</h4>

                <div class="col-md-6">
                    <label for="FechaRecepcion" class="form-label">Fecha de Recepci√≥n</label>
                    <input type="date" id="FechaRecepcion" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="FechaLimite" class="form-label">Fecha L√≠mite</label>
                    <input type="date" id="FechaLimite" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="FechaLimitePago" class="form-label">Fecha L√≠mite de Pago</label>
                    <input type="date" id="FechaLimitePago" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="FechaTurnado" class="form-label">Fecha de Turnado</label>
                    <input type="date" id="FechaTurnado" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="FechaTurnadoEntrega" class="form-label">Fecha de Entrega</label>
                    <input type="date" id="FechaTurnadoEntrega" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="FechaDevuelto" class="form-label">Fecha de Devoluci√≥n</label>
                    <input type="date" id="FechaDevuelto" class="form-control" disabled>
                </div>

                <!-- üìÑ REFERENCIA ADMINISTRATIVA -->
                <h4 class="mt-4 text-primary fw-bold">üìÑ Referencia Administrativa</h4>

                <div class="col-md-6">
                    <label for="OfPeticion" class="form-label">Oficio de Petici√≥n</label>
                    <input type="text" id="OfPeticion" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="NoTramite" class="form-label">N√∫mero de Tr√°mite</label>
                    <input type="text" id="NoTramite" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="DoctacionAnexo" class="form-label">Dotaci√≥n Anexa</label>
                    <input type="text" id="DoctacionAnexo" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="DocSAP" class="form-label">Documento SAP</label>
                    <input type="text" id="DocSAP" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="IntegraSAP" class="form-label">Integra SAP</label>
                    <input type="text" id="IntegraSAP" class="form-control" disabled>
                </div>

                <div class="col-md-6">
                    <label for="RemesaNumero" class="form-label">N√∫mero de Remesa</label>
                    <input type="text" id="RemesaNumero" class="form-control" disabled>
                </div>

                <!-- üí¨ COMENTARIOS -->
                <h4 class="mt-4 text-primary fw-bold">üí¨ Comentarios</h4>

                <div class="col-12">
                    <label for="Comentarios" class="form-label">Comentarios</label>
                    <textarea id="ComentariosFeed" class="form-control" rows="40" disabled></textarea>
                </div>
            </div>
        </form>
    </main>

    <footer>
        <p>¬© 2025 Sistema PagoTrack - Gesti√≥n de Pagos</p>
    </footer>
    <button id="addFondoBtn" class="col-md-6" hidden></button>
    <button id="FK_SRF" class="col-md-6" hidden></button>
    <script>
        let importesFF = {};

        document.getElementById('addFondoBtn').addEventListener('click', function () {
            let fondo = document.getElementById('FondoInput').value.trim();
            let importe = document.getElementById('ImporteInput').value.trim();

            if (fondo === '' || importe === '') {
                alert("Debes ingresar un fondo y un importe");
                return;
            }

            if (importesFF[fondo]) {
                alert("Este fondo ya ha sido agregado.");
                return;
            }

            importesFF[fondo] = importe;
            actualizarTabla();
            actualizarCampoOculto();
            limpiarInputs();
        });

        // Al cargar la p√°gina o cuando se necesite
        document.addEventListener('DOMContentLoaded', function () {
            const campoFecha = document.getElementById('FechaLimite');

            // Calcular fecha l√≠mite a 5 d√≠as h√°biles desde hoy
            const hoy = new Date();
            const fechaLimite = sumarDiasHabiles(hoy, 5);

            // Formatear a YYYY-MM-DD para input[type="date"]
            const yyyy = fechaLimite.getFullYear();
            const mm = String(fechaLimite.getMonth() + 1).padStart(2, '0');
            const dd = String(fechaLimite.getDate()).padStart(2, '0');
            const fechaFormateada = `${yyyy}-${mm}-${dd}`;

            campoFecha.value = fechaFormateada;

            const tipoTramite = document.getElementById('TipoTramite');
            const campoSRF = document.getElementById('FK_SRF');
            const contenedorSRF = campoSRF.closest('.col-md-6'); // oculta tambi√©n la etiqueta y padding

            // Ocultar al cargar
            contenedorSRF.style.display = 'none';
            campoSRF.removeAttribute('required');

            // Escuchar cambios
            tipoTramite.addEventListener('change', function () {
                if (this.value === 'CRF') {
                    contenedorSRF.style.display = 'block';
                    campoSRF.setAttribute('required', 'required');
                } else {
                    contenedorSRF.style.display = 'none';
                    campoSRF.removeAttribute('required');
                    campoSRF.value = ''; // Limpiar valor por si acaso
                }
            });
        });

        function actualizarTabla() {
            let tbody = document.querySelector('#fondosTable tbody');
            tbody.innerHTML = '';

            for (let fondo in importesFF) {
                let row = `<tr>
                            <td>${fondo}</td>
                            <td>${parseFloat(importesFF[fondo]).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}</td>
                        </tr>`;
                tbody.innerHTML += row;
            }
        }

        function eliminarFondo(fondo) {
            delete importesFF[fondo];
            actualizarTabla();
            actualizarCampoOculto();
        }

        function actualizarCampoOculto() {
            document.getElementById('Fondo').value = JSON.stringify(importesFF);
            //console.log(document.getElementById('Fondo').value);

            // Convertimos los valores del objeto a n√∫meros y sumamos
            let sumaTotal = Object.values(importesFF).reduce((total, valor) => total + parseFloat(valor), 0);

            // Asignamos el resultado al input con formato de 2 decimales
            document.getElementById('Importe').value = sumaTotal.toFixed(2);
        }

        function limpiarInputs() {
            document.getElementById('FondoInput').value = '';
            document.getElementById('ImporteInput').value = '';
        }

        // Funci√≥n para sumar d√≠as h√°biles (excluye s√°bados y domingos)
        function sumarDiasHabiles(fechaInicial, diasHabiles) {
            let fecha = new Date(fechaInicial);
            let diasSumados = 0;

            while (diasSumados < diasHabiles) {
                fecha.setDate(fecha.getDate() + 1);
                const dia = fecha.getDay();
                // 0 = domingo, 6 = s√°bado ‚Üí saltar fines de semana
                if (dia !== 0 && dia !== 6) {
                    diasSumados++;
                }
            }

            return fecha;
        }
    </script>
</body>

</html>